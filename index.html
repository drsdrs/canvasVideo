<html>
<head>
  <title>Preview Canvas</title>
  <style type="text/css">
    body { text-align: center; background: #222; }
    img {
      height:80%;
      border:4px solid black;
      background: #000;
    }
  </style>
  <script type="text/javascript">


  window.onload = function(){
    console.log("init");
    document.getElementById("record").addEventListener("click", function(){
      post("record", "", function(res){
        console.log("done");
      });
    });
    var imgEl = document.getElementById("img")


    imgLoad = false;
    date = Date.now()
    setImgData = function(){

      post("gimmiDataUri", "", function(data){
        imgEl.src = data;
        imgEl.onload = function(){
          //console.log("loaded in "+(Date.now()-date)+"ms");
          //date = Date.now()
          //window.requestAnimationFrame(setImgData);
          setImgData();
        }
      });
    }

    //window.requestAnimationFrame(setImgData);
    setImgData();
}

function post(url, sendData, responseCallback) {
  var xmlhttpRequest = new XMLHttpRequest();
  xmlhttpRequest.open("POST", url, true);
  xmlhttpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xmlhttpRequest.onreadystatechange = function(){
    if (xmlhttpRequest.readyState==4 && xmlhttpRequest.status==200 ){
      responseCallback((xmlhttpRequest.responseText));
    }
  }
  return xmlhttpRequest.send(sendData||'');
}


  </script>
</head>
<body>
  <img src="#" id="img">
  <button id="record">record</button>
</body>
</html>